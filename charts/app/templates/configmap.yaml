apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ .Release.Name }}-app-configmap"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
data:
  # global settings
  {{- with .Values.app.global }}
  {{- include "app.configValue" ( dict "Key" "APP_PUBLIC_PATH" "Value" .publicPath ) }}
  {{- include "app.configValue" ( dict "Key" "APP_GZIP" "Value" .gzip ) }}
  {{- include "app.configValue" ( dict "Key" "APP_SECURE_COOKIE" "Value" .secureCookie ) }}
  {{- include "app.configValue" ( dict "Key" "APP_COOKIE_POLICY" "Value" .cookiePolicy ) }}
  {{- include "app.configValue" ( dict "Key" "APP_ENDPOINT" "Value" .endpoint ) }}
  {{- include "app.configValue" ( dict "Key" "APP_VERBOSE" "Value" .verbose ) }}
  {{- end }}

  # database settings
  APP_DB_CRYPTD_SPWAN_ARGS: '--pidfilepath /tmp/mongocryptd.pid'
  {{- with .Values.app.database }}
  {{- include "app.configValue" ( dict "Key" "APP_DB_CRYPTD_URI" "Value" .cryptdUri ) }}
  {{- include "app.configValue" ( dict "Key" "APP_DB_CRYPTD_BYPASS_SPAWN" "Value" .cryptdBypassSpawn ) }}
  {{- end }}

  # session settings
  {{- with .Values.app.session }}
  {{- include "app.configValue" ( dict "Key" "APP_SESSION_LIFETIME" "Value" .lifetime ) }}
  {{- end }}

  # bull settings
  {{- with .Values.app.bull }}
  {{- include "app.configValue" ( dict "Key" "APP_BULL_PERSIST" "Value" .persist ) }}
  {{- include "app.configValue" ( dict "Key" "APP_BULL_MONITOR" "Value" .monitor ) }}
  {{- end }}

  # health checks settings
  {{- with .Values.app.health }}
  APP_HEALTH_ENABLED: "true"
  {{- include "app.configValue" ( dict "Key" "APP_HEALTH_PORT" "Value" .port ) }}
  {{- include "app.configValue" ( dict "Key" "APP_HEALTH_ALLOWED" "Value" .allowed ) }}
  {{- include "app.configValue" ( dict "Key" "APP_HEALTH_WORKER_BEAT" "Value" .workerBeat ) }}
  {{- end }}

  # smtp settings
  {{- with .Values.app.smtp }}
  {{- include "app.configValue" ( dict "Key" "APP_SMTP_FROM" "Value" .from ) }}
  {{- end }}

  # sentry settings
  {{- with .Values.app.sentry }}
  {{- include "app.configValue" ( dict "Key" "APP_SENTRY_DSN" "Value" .dsn ) }}
  {{- include "app.configValue" ( dict "Key" "APP_SENTRY_RELEASE" "Value" .release ) }}
  {{- include "app.configValue" ( dict "Key" "APP_SENTRY_ENVIRONMENT" "Value" ( default $.Release.Name .environment ) ) }}
  {{- include "app.configValue" ( dict "Key" "APP_SENTRY_TRACING" "Value" .tracing ) }}
  {{- include "app.configValue" ( dict "Key" "APP_SENTRY_TRACES_SAMPLE_RATE" "Value" .tracesSampleRate ) }}
  {{- end }}

  # limiter settings
  {{- with .Values.app.limiter }}
  {{- include "app.configValue" ( dict "Key" "APP_LIMITER_API" "Value" .api ) }}
  {{- end }}

  # prometheus settings
  {{- with .Values.app.prometheus }}
  {{- include "app.configValue" ( dict "Key" "APP_PROMETHEUS_ENABLED" "Value" .enabled ) }}
  {{- include "app.configValue" ( dict "Key" "APP_PROMETHEUS_INTERNAL" "Value" .internal ) }}
  {{- include "app.configValue" ( dict "Key" "APP_PROMETHEUS_INTERNAL_PORT" "Value" .internalPort ) }}
  {{- include "app.configValue" ( dict "Key" "APP_PROMETHEUS_EXTERNAL" "Value" .external ) }}
  {{- include "app.configValue" ( dict "Key" "APP_PROMETHEUS_EXTERNAL_PATH" "Value" .externalPath ) }}
  {{- include "app.configValue" ( dict "Key" "APP_PROMETHEUS_PREFIX" "Value" .prefix ) }}
  {{- end }}

  # html2pdf settings
  APP_HTML2PDF_ENDPOINT: "http://{{ .Release.Name }}-html2pdf:3000/"
